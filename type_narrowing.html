
<!DOCTYPE html>

<html lang="zh_CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Type narrowing &#8212; Mypy 0.940+dev.d02f39d1f0317448dbbec1e7a5417a3780c278f2 文档</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/classic.css" />
    
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/translations.js"></script>
    
    <link rel="index" title="索引" href="genindex.html" />
    <link rel="search" title="搜索" href="search.html" />
    <link rel="next" title="Duck type compatibility" href="duck_type_compatibility.html" />
    <link rel="prev" title="Type checking Python 2 code" href="python2.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>导航</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="总目录"
             accesskey="I">索引</a></li>
        <li class="right" >
          <a href="duck_type_compatibility.html" title="Duck type compatibility"
             accesskey="N">下一页</a> |</li>
        <li class="right" >
          <a href="python2.html" title="Type checking Python 2 code"
             accesskey="P">上一页</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">Mypy 0.940+dev.d02f39d1f0317448dbbec1e7a5417a3780c278f2 文档</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Type narrowing</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="type-narrowing">
<span id="id1"></span><h1>Type narrowing<a class="headerlink" href="#type-narrowing" title="永久链接至标题">¶</a></h1>
<p>This section is dedicated to  several type narrowing
techniques which are supported by mypy.</p>
<p>Type narrowing is when you convince a type checker that a broader type is actually more specific, for instance, that an object of type <code class="docutils literal notranslate"><span class="pre">Shape</span></code> is actually of the narrower type <code class="docutils literal notranslate"><span class="pre">Square</span></code>.</p>
<section id="type-narrowing-expressions">
<h2>Type narrowing expressions<a class="headerlink" href="#type-narrowing-expressions" title="永久链接至标题">¶</a></h2>
<p>The simplest way to narrow a type is to use one of the supported expressions:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://docs.python.org/3/library/functions.html#isinstance" title="(在 Python v3.10)"><code class="xref py py-func docutils literal notranslate"><span class="pre">isinstance()</span></code></a> like in <code class="docutils literal notranslate"><span class="pre">isinstance(obj,</span> <span class="pre">float)</span></code> will narrow <code class="docutils literal notranslate"><span class="pre">obj</span></code> to have <code class="docutils literal notranslate"><span class="pre">float</span></code> type</p></li>
<li><p><a class="reference external" href="https://docs.python.org/3/library/functions.html#issubclass" title="(在 Python v3.10)"><code class="xref py py-func docutils literal notranslate"><span class="pre">issubclass()</span></code></a> like in <code class="docutils literal notranslate"><span class="pre">issubclass(cls,</span> <span class="pre">MyClass)</span></code> will narrow <code class="docutils literal notranslate"><span class="pre">cls</span></code> to be <code class="docutils literal notranslate"><span class="pre">Type[MyClass]</span></code></p></li>
<li><p><code class="xref py py-func docutils literal notranslate"><span class="pre">type()</span></code> like in <code class="docutils literal notranslate"><span class="pre">type(obj)</span> <span class="pre">is</span> <span class="pre">int</span></code> will narrow <code class="docutils literal notranslate"><span class="pre">obj</span></code> to have <code class="docutils literal notranslate"><span class="pre">int</span></code> type</p></li>
<li><p><a class="reference external" href="https://docs.python.org/3/library/functions.html#callable" title="(在 Python v3.10)"><code class="xref py py-func docutils literal notranslate"><span class="pre">callable()</span></code></a> like in <code class="docutils literal notranslate"><span class="pre">callable(obj)</span></code> will narrow object to callable type</p></li>
</ul>
<p>Type narrowing is contextual. For example, based on the condition, mypy will narrow an expression only within an <code class="docutils literal notranslate"><span class="pre">if</span></code> branch:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">function</span><span class="p">(</span><span class="n">arg</span><span class="p">:</span> <span class="nb">object</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="c1"># Type is narrowed within the ``if`` branch only</span>
        <span class="n">reveal_type</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>  <span class="c1"># Revealed type: &quot;builtins.int&quot;</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="c1"># Type is narrowed differently within this ``elif`` branch:</span>
        <span class="n">reveal_type</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>  <span class="c1"># Revealed type: &quot;builtins.str | builtins.bool&quot;</span>

        <span class="c1"># Subsequent narrowing operations will narrow the type further</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="n">reveal_type</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>  <span class="c1"># Revealed type: &quot;builtins.bool&quot;</span>

    <span class="c1"># Back outside of the ``if`` statement, the type isn&#39;t narrowed:</span>
    <span class="n">reveal_type</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>  <span class="c1"># Revealed type: &quot;builtins.object&quot;</span>
</pre></div>
</div>
<p>Mypy understands the implications <code class="docutils literal notranslate"><span class="pre">return</span></code> or exception raising can have
for what type an object could be:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">function</span><span class="p">(</span><span class="n">arg</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">return</span>

    <span class="c1"># `arg` can&#39;t be `int` at this point:</span>
    <span class="n">reveal_type</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>  <span class="c1"># Revealed type: &quot;builtins.str&quot;</span>
</pre></div>
</div>
<p>We can also use <code class="docutils literal notranslate"><span class="pre">assert</span></code> to narrow types in the same context:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">function</span><span class="p">(</span><span class="n">arg</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
    <span class="n">reveal_type</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>  <span class="c1"># Revealed type: &quot;builtins.int&quot;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>With <a class="reference internal" href="command_line.html#cmdoption-mypy-warn-unreachable"><code class="xref std std-option docutils literal notranslate"><span class="pre">--warn-unreachable</span></code></a>
narrowing types to some impossible state will be treated as an error.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">function</span><span class="p">(</span><span class="n">arg</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="c1"># error: Subclass of &quot;int&quot; and &quot;str&quot; cannot exist:</span>
    <span class="c1"># would have incompatible method signatures</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>

    <span class="c1"># error: Statement is unreachable</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;so mypy concludes the assert will always trigger&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Without <code class="docutils literal notranslate"><span class="pre">--warn-unreachable</span></code> mypy will simply not check code it deems to be
unreachable. See <a class="reference internal" href="common_issues.html#unreachable"><span class="std std-ref">Unreachable code</span></a> for more information.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">x</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
<span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
<span class="n">reveal_type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>  <span class="c1"># Revealed type is &quot;builtins.int&quot;</span>
<span class="nb">print</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="s1">&#39;!&#39;</span><span class="p">)</span>  <span class="c1"># Typechecks with `mypy`, but fails in runtime.</span>
</pre></div>
</div>
</div>
<section id="issubclass">
<h3>issubclass<a class="headerlink" href="#issubclass" title="永久链接至标题">¶</a></h3>
<p>Mypy can also use <a class="reference external" href="https://docs.python.org/3/library/functions.html#issubclass" title="(在 Python v3.10)"><code class="xref py py-func docutils literal notranslate"><span class="pre">issubclass()</span></code></a>
for better type inference when working with types and metaclasses:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyCalcMeta</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">calc</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="o">...</span>

<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">o</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">t</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>  <span class="c1"># We must use a variable here</span>
    <span class="n">reveal_type</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>  <span class="c1"># Revealed type is &quot;builtins.type&quot;</span>

    <span class="k">if</span> <span class="n">issubtype</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">MyCalcMeta</span><span class="p">):</span>  <span class="c1"># `issubtype(type(o), MyCalcMeta)` won&#39;t work</span>
        <span class="n">reveal_type</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>  <span class="c1"># Revealed type is &quot;Type[MyCalcMeta]&quot;</span>
        <span class="n">t</span><span class="o">.</span><span class="n">calc</span><span class="p">()</span>  <span class="c1"># Okay</span>
</pre></div>
</div>
</section>
<section id="callable">
<h3>callable<a class="headerlink" href="#callable" title="永久链接至标题">¶</a></h3>
<p>Mypy knows what types are callable and which ones are not during type checking.
So, we know what <code class="docutils literal notranslate"><span class="pre">callable()</span></code> will return. For example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Callable</span>

<span class="n">x</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[],</span> <span class="nb">int</span><span class="p">]</span>

<span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">reveal_type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>  <span class="c1"># N: Revealed type is &quot;def () -&gt; builtins.int&quot;</span>
<span class="k">else</span><span class="p">:</span>
    <span class="o">...</span>  <span class="c1"># Will never be executed and will raise error with `--warn-unreachable`</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">callable</span></code> function can even split <code class="docutils literal notranslate"><span class="pre">Union</span></code> type
for callable and non-callable parts:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Union</span>

<span class="n">x</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Callable</span><span class="p">[[],</span> <span class="nb">int</span><span class="p">]]</span>

<span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">reveal_type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>  <span class="c1"># N: Revealed type is &quot;def () -&gt; builtins.int&quot;</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">reveal_type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>  <span class="c1"># N: Revealed type is &quot;builtins.int&quot;</span>
</pre></div>
</div>
</section>
</section>
<section id="casts">
<span id="id2"></span><h2>Casts<a class="headerlink" href="#casts" title="永久链接至标题">¶</a></h2>
<p>Mypy supports type casts that are usually used to coerce a statically
typed value to a subtype. Unlike languages such as Java or C#,
however, mypy casts are only used as hints for the type checker, and they
don’t perform a runtime type check. Use the function <a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.cast" title="(在 Python v3.10)"><code class="xref py py-func docutils literal notranslate"><span class="pre">cast()</span></code></a>
to perform a cast:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">cast</span>

<span class="n">o</span><span class="p">:</span> <span class="nb">object</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">o</span><span class="p">)</span>  <span class="c1"># OK</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">o</span><span class="p">)</span>  <span class="c1"># OK (cast performs no actual runtime check)</span>
</pre></div>
</div>
<p>To support runtime checking of casts such as the above, we’d have to check
the types of all list items, which would be very inefficient for large lists.
Casts are used to silence spurious
type checker warnings and give the type checker a little help when it can’t
quite understand what is going on.</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>You can use an assertion if you want to perform an actual runtime check:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="n">o</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">o</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span>  <span class="c1"># Error: can&#39;t add &#39;object&#39; and &#39;int&#39;</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">o</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span>  <span class="c1"># OK: type of &#39;o&#39; is &#39;int&#39; here</span>
</pre></div>
</div>
</div>
<p>You don’t need a cast for expressions with type <code class="docutils literal notranslate"><span class="pre">Any</span></code>, or when
assigning to a variable with type <code class="docutils literal notranslate"><span class="pre">Any</span></code>, as was explained earlier.
You can also use <code class="docutils literal notranslate"><span class="pre">Any</span></code> as the cast target type – this lets you perform
any operations on the result. For example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">cast</span><span class="p">,</span> <span class="n">Any</span>

<span class="n">x</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">x</span><span class="o">.</span><span class="n">whatever</span><span class="p">()</span>  <span class="c1"># Type check error</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">Any</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
<span class="n">y</span><span class="o">.</span><span class="n">whatever</span><span class="p">()</span>  <span class="c1"># Type check OK (runtime error)</span>
</pre></div>
</div>
</section>
<section id="user-defined-type-guards">
<span id="type-guards"></span><h2>User-Defined Type Guards<a class="headerlink" href="#user-defined-type-guards" title="永久链接至标题">¶</a></h2>
<p>Mypy supports User-Defined Type Guards (<span class="target" id="index-0"></span><a class="pep reference external" href="https://www.python.org/dev/peps/pep-0647"><strong>PEP 647</strong></a>).</p>
<p>A type guard is a way for programs to influence conditional
type narrowing employed by a type checker based on runtime checks.</p>
<p>Basically, a <code class="docutils literal notranslate"><span class="pre">TypeGuard</span></code> is a “smart” alias for a <code class="docutils literal notranslate"><span class="pre">bool</span></code> type.
Let’s have a look at the regular <code class="docutils literal notranslate"><span class="pre">bool</span></code> example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">is_str_list</span><span class="p">(</span><span class="n">val</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">object</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
  <span class="sd">&quot;&quot;&quot;Determines whether all objects in the list are strings&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">val</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">func1</span><span class="p">(</span><span class="n">val</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">object</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">is_str_list</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
        <span class="n">reveal_type</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>  <span class="c1"># Reveals list[object]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">val</span><span class="p">))</span> <span class="c1"># Error: incompatible type</span>
</pre></div>
</div>
<p>The same example with <code class="docutils literal notranslate"><span class="pre">TypeGuard</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">TypeGuard</span>  <span class="c1"># use `typing_extensions` for Python 3.9 and below</span>

<span class="k">def</span> <span class="nf">is_str_list</span><span class="p">(</span><span class="n">val</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">object</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">TypeGuard</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
    <span class="sd">&quot;&quot;&quot;Determines whether all objects in the list are strings&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">val</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">func1</span><span class="p">(</span><span class="n">val</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">object</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">is_str_list</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
        <span class="n">reveal_type</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>  <span class="c1"># list[str]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">val</span><span class="p">))</span> <span class="c1"># ok</span>
</pre></div>
</div>
<p>How does it work? <code class="docutils literal notranslate"><span class="pre">TypeGuard</span></code> narrows the first function argument (<code class="docutils literal notranslate"><span class="pre">val</span></code>)
to the type specified as the first type parameter (<code class="docutils literal notranslate"><span class="pre">list[str]</span></code>).</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>Narrowing is
<a class="reference external" href="https://www.python.org/dev/peps/pep-0647/#enforcing-strict-narrowing">not strict</a>.
For example, you can narrow <code class="docutils literal notranslate"><span class="pre">str</span></code> to <code class="docutils literal notranslate"><span class="pre">int</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TypeGuard</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
    <span class="k">return</span> <span class="kc">True</span>
</pre></div>
</div>
<p>Note: since strict narrowing is not enforced, it’s easy
to break type safety.</p>
<p>However, there are many ways a determined or uninformed developer can
subvert type safety – most commonly by using cast or Any.
If a Python developer takes the time to learn about and implement
user-defined type guards within their code,
it is safe to assume that they are interested in type safety
and will not write their type guard functions in a way
that will undermine type safety or produce nonsensical results.</p>
</div>
<section id="generic-typeguards">
<h3>Generic TypeGuards<a class="headerlink" href="#generic-typeguards" title="永久链接至标题">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">TypeGuard</span></code> can also work with generic types:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">TypeVar</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">TypeGuard</span>  <span class="c1"># use `typing_extensions` for `python&lt;3.10`</span>

<span class="n">_T</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;_T&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">is_two_element_tuple</span><span class="p">(</span><span class="n">val</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">_T</span><span class="p">,</span> <span class="o">...</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">TypeGuard</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">_T</span><span class="p">,</span> <span class="n">_T</span><span class="p">]]:</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>

<span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">names</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]):</span>
    <span class="k">if</span> <span class="n">is_two_element_tuple</span><span class="p">(</span><span class="n">names</span><span class="p">):</span>
        <span class="n">reveal_type</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>  <span class="c1"># tuple[str, str]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">reveal_type</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>  <span class="c1"># tuple[str, ...]</span>
</pre></div>
</div>
</section>
<section id="typeguards-with-parameters">
<h3>Typeguards with parameters<a class="headerlink" href="#typeguards-with-parameters" title="永久链接至标题">¶</a></h3>
<p>Type guard functions can accept extra arguments:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Type</span><span class="p">,</span> <span class="n">TypeVar</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">TypeGuard</span>  <span class="c1"># use `typing_extensions` for `python&lt;3.10`</span>

<span class="n">_T</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;_T&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">is_set_of</span><span class="p">(</span><span class="n">val</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="nb">type</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">_T</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">TypeGuard</span><span class="p">[</span><span class="nb">set</span><span class="p">[</span><span class="n">_T</span><span class="p">]]:</span>
    <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">val</span><span class="p">)</span>

<span class="n">items</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span>
<span class="k">if</span> <span class="n">is_set_of</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">reveal_type</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>  <span class="c1"># set[str]</span>
</pre></div>
</div>
</section>
<section id="typeguards-as-methods">
<h3>TypeGuards as methods<a class="headerlink" href="#typeguards-as-methods" title="永久链接至标题">¶</a></h3>
<blockquote>
<div><p>A method can also serve as the <code class="docutils literal notranslate"><span class="pre">TypeGuard</span></code>:</p>
</div></blockquote>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">StrValidator</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">is_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TypeGuard</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">to_validate</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">StrValidator</span><span class="p">()</span><span class="o">.</span><span class="n">is_valid</span><span class="p">(</span><span class="n">to_validate</span><span class="p">):</span>
        <span class="n">reveal_type</span><span class="p">(</span><span class="n">to_validate</span><span class="p">)</span>  <span class="c1"># Revealed type is &quot;builtins.str&quot;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>Note, that <code class="docutils literal notranslate"><span class="pre">TypeGuard</span></code>
<a class="reference external" href="https://www.python.org/dev/peps/pep-0647/#narrowing-of-implicit-self-and-cls-parameters">does not narrow</a>
types of <code class="docutils literal notranslate"><span class="pre">self</span></code> or <code class="docutils literal notranslate"><span class="pre">cls</span></code> implicit arguments.</p>
<p>If narrowing of <code class="docutils literal notranslate"><span class="pre">self</span></code> or <code class="docutils literal notranslate"><span class="pre">cls</span></code> is required,
the value can be passed as an explicit argument to a type guard function:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Parent</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">method</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">reveal_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>  <span class="c1"># Revealed type is &quot;Parent&quot;</span>
        <span class="k">if</span> <span class="n">is_child</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">reveal_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>  <span class="c1"># Revealed type is &quot;Child&quot;</span>

<span class="k">class</span> <span class="nc">Child</span><span class="p">(</span><span class="n">Parent</span><span class="p">):</span>
    <span class="o">...</span>

<span class="k">def</span> <span class="nf">is_child</span><span class="p">(</span><span class="n">instance</span><span class="p">:</span> <span class="n">Parent</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TypeGuard</span><span class="p">[</span><span class="n">Child</span><span class="p">]:</span>
    <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">Child</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="assignment-expressions-as-typeguards">
<h3>Assignment expressions as TypeGuards<a class="headerlink" href="#assignment-expressions-as-typeguards" title="永久链接至标题">¶</a></h3>
<p>Sometimes you might need to create a new variable and narrow it
to some specific type at the same time.
This can be achieved by using <code class="docutils literal notranslate"><span class="pre">TypeGuard</span></code> together
with <a class="reference external" href="https://docs.python.org/3/whatsnew/3.8.html#assignment-expressions">:= operator</a>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">TypeGuard</span>  <span class="c1"># use `typing_extensions` for `python&lt;3.10`</span>

<span class="k">def</span> <span class="nf">is_float</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TypeGuard</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
    <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">is_float</span><span class="p">(</span><span class="n">x</span> <span class="o">:=</span> <span class="n">a</span><span class="p">):</span>
        <span class="n">reveal_type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>  <span class="c1"># N: Revealed type is &#39;builtins.float&#39;</span>
        <span class="n">reveal_type</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>  <span class="c1"># N: Revealed type is &#39;builtins.object&#39;</span>
    <span class="n">reveal_type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>  <span class="c1"># N: Revealed type is &#39;builtins.object&#39;</span>
    <span class="n">reveal_type</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>  <span class="c1"># N: Revealed type is &#39;builtins.object&#39;</span>
</pre></div>
</div>
<p>What happens here?</p>
<ol class="arabic simple">
<li><p>We create a new variable <code class="docutils literal notranslate"><span class="pre">x</span></code> and assign a value of <code class="docutils literal notranslate"><span class="pre">a</span></code> to it</p></li>
<li><p>We run <code class="docutils literal notranslate"><span class="pre">is_float()</span></code> type guard on <code class="docutils literal notranslate"><span class="pre">x</span></code></p></li>
<li><p>It narrows <code class="docutils literal notranslate"><span class="pre">x</span></code> to be <code class="docutils literal notranslate"><span class="pre">float</span></code> in the <code class="docutils literal notranslate"><span class="pre">if</span></code> context and does not touch <code class="docutils literal notranslate"><span class="pre">a</span></code></p></li>
</ol>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>The same will work with <code class="docutils literal notranslate"><span class="pre">isinstance(x</span> <span class="pre">:=</span> <span class="pre">a,</span> <span class="pre">float)</span></code> as well.</p>
</div>
</section>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <div>
    <h3><a href="index.html">目录</a></h3>
    <ul>
<li><a class="reference internal" href="#">Type narrowing</a><ul>
<li><a class="reference internal" href="#type-narrowing-expressions">Type narrowing expressions</a><ul>
<li><a class="reference internal" href="#issubclass">issubclass</a></li>
<li><a class="reference internal" href="#callable">callable</a></li>
</ul>
</li>
<li><a class="reference internal" href="#casts">Casts</a></li>
<li><a class="reference internal" href="#user-defined-type-guards">User-Defined Type Guards</a><ul>
<li><a class="reference internal" href="#generic-typeguards">Generic TypeGuards</a></li>
<li><a class="reference internal" href="#typeguards-with-parameters">Typeguards with parameters</a></li>
<li><a class="reference internal" href="#typeguards-as-methods">TypeGuards as methods</a></li>
<li><a class="reference internal" href="#assignment-expressions-as-typeguards">Assignment expressions as TypeGuards</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  </div>
  <div>
    <h4>上一个主题</h4>
    <p class="topless"><a href="python2.html"
                          title="上一章">Type checking Python 2 code</a></p>
  </div>
  <div>
    <h4>下一个主题</h4>
    <p class="topless"><a href="duck_type_compatibility.html"
                          title="下一章">Duck type compatibility</a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>本页</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/type_narrowing.rst.txt"
            rel="nofollow">显示源代码</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">快速搜索</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="转向" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>导航</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="总目录"
             >索引</a></li>
        <li class="right" >
          <a href="duck_type_compatibility.html" title="Duck type compatibility"
             >下一页</a> |</li>
        <li class="right" >
          <a href="python2.html" title="Type checking Python 2 code"
             >上一页</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">Mypy 0.940+dev.d02f39d1f0317448dbbec1e7a5417a3780c278f2 文档</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Type narrowing</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; 版权所有 2016, Jukka Lehtosalo.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.4.0.
    </div>
  </body>
</html>